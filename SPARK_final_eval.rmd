---
title: "SPARK in Staten Island"
output: pdf_document
author: Evaluated on behalf of Borough Hall and New Dorp High School by Fil Babalievsky and Atishay Sehgal
abstract: The Staten Island Borough President's Office and New Dorp High School, advised by Dr. John Ratey, have begun an evaluation of the effects of intense aerobic exercise on academic achievement.

---

# Introduction

This is a replication file for Babalievsky and Sehgal (2018), an evaluation of Project SPARK.

# Preliminaries

First we load prerequisite pack and set our working directory to the path with the data (not a local file--we cannot store the data in a public repo.)

```{r}
install.packages("tidyverse")
install.packages("stargazer")
install.packages("Rcurl")
install.packages("readxl")
library(tidyverse)
library(dplyr)
library(stargazer)
library(RCurl)
library(readxl)
setwd("~/Dropbox/New SI Stuff/SPARK Eval")
```

Next we import a function for clustered standard errors.

```{r}
# import the function from repository
# thanks https://economictheoryblog.com/2016/12/13/clustered-standard-errors-in-r/
url_robust <- "https://raw.githubusercontent.com/IsidoreBeautrelet/economictheoryblog/master/robust_summary.R"
eval(parse(text = getURL(url_robust, ssl.verifypeer = FALSE)),
     envir=.GlobalEnv)
```

# The Data

First we import data for the ninth graders in the Health Sciences SLC in New Dorp High who are enrolled in SPARK. Note that there are 57 students in SPARK and 37 students in New Dorp's 9th grade class not in SPARK. The seventh tab of the Excel file holds data for SPARK students in their first marking periods in English, math, and science. There are 171 observations, 3 classes times 51 students.

```{r}
hs_spark_1<-read_excel("SPARK 2017 HN copy.xlsx", sheet = 7, col_names = FALSE)
names(hs_spark_1)<-c("StudentID", "Course", "Mark1")
hs_spark_1
nrow(hs_spark_1)
#dummy for Spark participation
hs_spark_1$Spark<-1
#dummy for New Dorp High School students
hs_spark_1$HS<-1
```

Next we import data for ninth graders who are in the Health Sciences SLC in New Dorp High School but not in SPARK. There are 111 observations, 3 classes times 37 students.

```{r}
hs_nonspark_1<-read_excel("SPARK 2017 HN copy.xlsx", sheet = 8, col_names = FALSE)
names(hs_nonspark_1)<-c("StudentID", "Course", "Mark1")
#dummy for SPARK non-participation
hs_nonspark_1$Spark<-0
#dummy for New Dorp High School Students
hs_nonspark_1$HS<-1
nrow(hs_nonspark_1)
```

And finally, we import data for ninth graders who are not in the Health Sciences SLC in New Dorp High School and therefore not in SPARK.

```{r}
non_hs_1<-read_excel("SPARK 2017 HN copy.xlsx", sheet = 9, col_names = FALSE)
names(non_hs_1)<-c("StudentID", "Course", "Mark1")
non_hs_1$Spark<-0
non_hs_1$HS<-0
```

Here we combine the results from the first marking period with those of the second marking period.

```{r}
first<-rbind(hs_spark_1, hs_nonspark_1)
first<-rbind(first, non_hs_1)

all_mp_2<-read_excel("SPARK MP2 Grades copy.xlsx", sheet = 1)
names(all_mp_2)
names(all_mp_2)<-c("StudentID", "Course", "Mark2")

total<-merge(first, all_mp_2, by=c("StudentID", "Course"))
total$diff<-as.numeric(as.character(total$Mark2))-as.numeric(as.character(total$Mark1))


total_hs<-total[total$HS==1,]
nrow(total_hs[total_hs$Spark==0,])
nrow(total_hs[total_hs$Spark==1,])

```


Next we look at the data from marking periods 3 and 4 and try to merge them with the data from periods 1 and 2.

```{r}
three_and_four<-read_excel("SPARK 2017 Term 2 MP3 and MP4 copy.xlsx", sheet = 2)
three_and_four<-three_and_four[,-6]
names(three_and_four)<-c("StudentID", "Blank1",  "Course", "Blank3", "Blank4", "Blank5", "MP3", "MP4", "Final")
#three_and_four<-read_excel("SPARK 2017 Term 2 MP3 and MP4.xlsx", sheet = 1, col_names = TRUE)
three_and_four
max(three_and_four$StudentID)
max(total_hs$StudentID)
min(total_hs$StudentID)
min(three_and_four$StudentID)
mean(as.numeric(three_and_four$MP4), na.rm=TRUE)-mean(as.numeric(three_and_four$MP3), na.rm=TRUE)

ncol(three_and_four)
nrow(three_and_four)

colnames(three_and_four)
colnames(total)

is.character(three_and_four$Course)
is.character(total$Course)

is.numeric(three_and_four$StudentID)
is.numeric(total$StudentID)

total$paste<-paste(total$StudentID, total$Course)
three_and_four

intermediatmerge(total_hs, three_and_four, all = TRUE)
nrow(all)
head(all)
head(total_hs)
head(three_and_four)
all(unique(total$))

Final<-merge(total_hs, three_and_four, by=c("StudentID", "Course"))
length(three_and_four$Course)


Final<-all[all$HS==1,]
Final

Final_All_Grades<-total_hs[total_hs$StudentID==three_and_four$StudentID,]
Final_All_Grades<-total_hs[total_hs$StudentID %in% three_and_four$StudentID, ]

#Final_All_Grades<-merge(total, three_and_four, by=c("StudentID", "Course"))
Final_All_Grades
is.numeric(three_and_four$StudentID)
is.numeric(total$StudentID)
is.character(three_and_four$Course)
is.character(total_hs$Course)
nrow(Final_All_Grades)

total_hs<-total[total$HS==1,]
total_hs$firsfour<-substr(total_hs$Course, 1, 4)
total_hs$lastthree<-substr(total_hs$Course, 6, 8)
total_hs$Course2<-paste(total_hs$firsfour, total_hs$lastthree, sep="2")
total_hs$Course<-total_hs$Course2
total_hs
nrow(total_hs)
three_and_four
Final<-merge(total_hs, three_and_four, by=c("StudentID", "Course"))
Final
```

```{r}
total_hs$coursechar<-as.character(total_hs$Course)
total_hs$Type<-substr(total_hs$coursechar, 1, 1)

sorted<-sort(total_hs$StudentID)
head(sorted)
sorted

sorted2<-sort(three_and_four$StudentID)
sorted2
head(sorted2)

three_and_four$coursechar<-as.character(three_and_four$Course)
three_and_four$Type<-substr(three_and_four$coursechar, 1, 1)

onetwomath<-total_hs[total_hs$Type=="M",]
threefourmath<-three_and_four[three_and_four$Type=="M",]
onetwomath
threefourmath
Finalmath<-merge(onetwomath, threefourmath, by=c("StudentID"))
Finalmath

```


```{r}
three_and_four_again<-read_excel("SPARK 2017 Term 2 MP3 and MP4 copy.xlsx", sheet = 1)
three_and_four_again
names(three_and_four)<-c("StudentID", "Blank1", "Blank2",  "Course", "Blank3", "Blank4", "Blank5", "Blank6", "MP3", "MP4", "Final")

total_hs<-total[total$HS==1,]
total_hs$firsfour<-substr(total_hs$Course, 1, 4)
total_hs$lastthree<-substr(total_hs$Course, 6, 8)
total_hs$Course2<-paste(total_hs$firsfour, total_hs$lastthree, sep="2")
total_hs$Course<-total_hs$Course2
total_hs
nrow(total_hs)

Final<-merge(total_hs, three_and_four_again, by=c("StudentID", "Course"))
Final
nrow(Final)

```


```{r}

total_hs$mp1<-as.numeric(as.character(total_hs$Mark1))
mean(total_hs$diff)

summary(total_hs$diff)

lm1<-lm(diff~Spark,data=total_hs)
summary(lm1)
summary(lm1, cluster=c("StudentID"))

lm1a<-lm(mp1~Spark,data=total_hs)
summary(lm1a)
summary(lm1a, cluster=c("StudentID"))

total_hs$coursechar<-as.character(total_hs$Course)
total_hs$Type<-substr(total_hs$coursechar, 1, 1)


total_hs$Spark_math<-0
total_hs$Spark_math[total_hs$Spark==1&total_hs$Type=="M"]<-1

total_hs$Spark_sci<-0
total_hs$Spark_sci[total_hs$Spark==1&total_hs$Type=="S"]<-1

total_hs$Spark_eng<-0
total_hs$Spark_eng[total_hs$Spark==1&total_hs$Type=="E"]<-1



total_hs$math<-0
total_hs$math[total_hs$Type=="M"]<-1

total_hs$sci<-0
total_hs$sci[total_hs$Type=="S"]<-1

total_hs$eng<-0
total_hs$eng[total_hs$Type=="E"]<-1



lm2<-lm(diff~Spark_math+Spark_sci+Spark_eng+math+eng,data=total_hs)
summary(lm2)
summary(lm2, cluster=c("StudentID"))

lm2a<-lm(mp1~Spark_math+Spark_sci+Spark_eng+math+eng,data=total_hs)
summary(lm2a)
summary(lm2a, cluster=c("StudentID"))

write.csv(total_hs, file = "totalhs.csv")

levels(total_hs$Course)

```
